"use strict";
var __rest = (this && this.__rest) || function (s, e) {
    var t = {};
    for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0)
        t[p] = s[p];
    if (s != null && typeof Object.getOwnPropertySymbols === "function")
        for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) {
            if (e.indexOf(p[i]) < 0 && Object.prototype.propertyIsEnumerable.call(s, p[i]))
                t[p[i]] = s[p[i]];
        }
    return t;
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.default = MultiSelect;
const jsx_runtime_1 = require("react/jsx-runtime");
const react_1 = require("react");
function MultiSelect(_a) {
    var { options = [], custom = false, searchable = false, className = '', name = '', placeholder = 'Select an option' } = _a, htmlProps = __rest(_a, ["options", "custom", "searchable", "className", "name", "placeholder"]);
    const [inputValue, setInputValue] = (0, react_1.useState)('');
    const [selected, setSelected] = (0, react_1.useState)([]);
    const [filteredOptions, setFilteredOptions] = (0, react_1.useState)([]);
    const [isDropdownOpen, setIsDropdownOpen] = (0, react_1.useState)(false);
    const wrapperRef = (0, react_1.useRef)(null);
    const inputRef = (0, react_1.useRef)(null);
    (0, react_1.useEffect)(() => {
        let filtered = [];
        if (searchable && inputValue) {
            const query = inputValue.toLowerCase();
            filtered = options.filter((option) => option.toLowerCase().includes(query) && !selected.includes(option));
        }
        else {
            filtered = options.filter((option) => !selected.includes(option));
        }
        setFilteredOptions(filtered);
    }, [inputValue, options, selected, searchable]);
    (0, react_1.useEffect)(() => {
        const handleClickOutside = (event) => {
            if (wrapperRef.current &&
                !wrapperRef.current.contains(event.target)) {
                setIsDropdownOpen(false);
                setInputValue('');
            }
        };
        document.addEventListener('mousedown', handleClickOutside);
        return () => document.removeEventListener('mousedown', handleClickOutside);
    }, []);
    const handleInputChange = (e) => {
        setInputValue(e.target.value);
        if (!isDropdownOpen && (searchable || custom)) {
            setIsDropdownOpen(true);
        }
    };
    const addTag = (tag) => {
        var _a;
        tag = tag.trim();
        if (!tag || selected.includes(tag))
            return;
        if (custom || options.includes(tag)) {
            setSelected([...selected, tag]);
            setInputValue('');
            setIsDropdownOpen(false);
            (_a = inputRef.current) === null || _a === void 0 ? void 0 : _a.blur();
        }
    };
    const removeTag = (index) => {
        var _a;
        setSelected(selected.filter((_, i) => i !== index));
        (_a = inputRef.current) === null || _a === void 0 ? void 0 : _a.blur();
    };
    const handleKeyDown = (e) => {
        if (['Enter', 'Tab'].includes(e.key)) {
            e.preventDefault();
            if (inputValue && (custom || options.includes(inputValue))) {
                addTag(inputValue);
            }
        }
        else if (e.key === 'Backspace' && !inputValue && selected.length > 0) {
            removeTag(selected.length - 1);
        }
    };
    const toggleDropdown = () => {
        if (filteredOptions.length > 0 || custom || searchable) {
            setIsDropdownOpen(!isDropdownOpen);
        }
    };
    return ((0, jsx_runtime_1.jsxs)("div", Object.assign({ className: `frui-field-multiselect ${className}`, role: "combobox", "aria-multiselectable": "true", "aria-expanded": isDropdownOpen }, htmlProps, { ref: wrapperRef, children: [(0, jsx_runtime_1.jsx)("div", { className: "frui-field-multiselect-control", onClick: toggleDropdown, children: selected.length > 0 ? (selected.map((tag, index) => ((0, jsx_runtime_1.jsxs)("span", { className: "frui-field-multiselect-tag", children: [tag, (0, jsx_runtime_1.jsx)("button", { type: "button", className: "frui-field-multiselect-tag-remove", onClick: (e) => {
                                e.stopPropagation();
                                removeTag(index);
                            }, "aria-label": `Remove ${tag}`, children: "\u00D7" })] }, index)))) : ((0, jsx_runtime_1.jsx)("span", { className: "frui-field-multiselect-placeholder", children: placeholder })) }), (0, jsx_runtime_1.jsxs)("div", { className: "frui-field-multiselect-dropdown", style: { display: isDropdownOpen ? 'block' : 'none' }, children: [(searchable || custom) && ((0, jsx_runtime_1.jsx)("div", { className: "frui-field-multiselect-search", children: (0, jsx_runtime_1.jsx)("input", { ref: inputRef, type: "text", value: inputValue, onChange: handleInputChange, onKeyDown: handleKeyDown, className: "frui-field-multiselect-search-control", placeholder: placeholder, "aria-autocomplete": searchable ? 'list' : 'none', autoFocus: true }) })), filteredOptions.length > 0 && ((0, jsx_runtime_1.jsx)("div", { className: "frui-field-multiselect-options", children: filteredOptions.map((option, index) => ((0, jsx_runtime_1.jsx)("div", { className: "frui-field-multiselect-option", onClick: () => addTag(option), role: "option", "aria-selected": selected.includes(option), children: option }, index))) }))] }), selected.map((tag, index) => ((0, jsx_runtime_1.jsx)("input", { type: "hidden", name: `${name}[]`, value: tag }, index)))] })));
}
;
